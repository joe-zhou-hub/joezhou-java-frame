# 1. 概念入门

**概念：** springmvc是spring框架的控制层技术，核心是前端控制器 `DispatcherServlet`，负责管理和调用其它组件以处理用户的http请求，降低组件间的耦合度：
- 当浏览器请求符合前端控制器规则时，WEB服务器会将其转交给前端控制器。
- 前端控制器调用处理器映射器 `HandlerMapping`：
    - 根据请求URL找到某自定义Handler，将其和拦截器（若有）封装成执行链并返回。
- 前端控制器调用处理器适配器 `HandlerAdapter`：
    - 执行执行链中拦截器和Handler并返回一个ModelAndView对象。
- 前端控制器调用视图解析器 `ViewResolver`：
    - 将ModelAndView中的逻辑视图名拼接前后缀后解析为物理视图名，并返回View对象。 
- 前端控制器根据View组装HTML页面响应给浏览器，浏览器渲染页面:
    - 渲染：浏览器解析HTML，构建DOM树，整合CSS和JS，布局，绘制等过程。

> z-image/一个核心三个组件.png

# 2. 基础配通

**流程：**
- 添加依赖：spring-webmvc
- 在web.xml中配置前端控制器类 `o.s.w.s.DispatcherServlet`：
    - 使用 `<init-param>` 注入 `contextConfigLocation=springmvc主配文件`：
        - 默认加载 `/WEB-INF/配对名-servlet.xml`。
    - 使用 `<url-pattern>` 设置前端控制器拦截规则，可设置多个：
        - `*.do/.action`：仅拦截以.do或.action结尾的请求。
        - `/`：拦截除JSP外的一切请求，静态资源请求需在web.xml中手动放行。
        - `/*`：拦截包括JSP的一切请求，静态资源请求需在web.xml中手动放行，不建议。
- 开发springmvc主配文件：
    - 使用 `<mvc:annotation-driven />` 驱动管理处理器映射器类和处理器适配器类。
    - 使用 `<context:component-scan>` 包扫描 `@Component`。
    - 管理视图解析器类：`o.s.w.s.v.InternalResourceViewResolver`：
        - 注入 `prifix` 以配置响应路径前缀，可选。
        - 注入 `suffix` 以配置响应路径后缀，可选。
- 开发动作类：添加 `@Controller`。
- 开发动作方法：添加 `@RequestMapping` 设置方法路由，可省略两端 `/` 和 `.do` 后缀：
    - 修饰符必须 `public`，方法名随意。
    - 若返回字符串，会自动拼接视图解析器前后缀并执行请求转发。
- 测试：请求URL中不可省略 `.do` 后缀（若有）。

**源码：** /springmvc4/
- res: `pom.xml`
- res: `WEB-INF/web.xml`
- res: `classpath:spring/springmvc.xml`
- src: `c.j.controller.StartController`
- psm: `{{tomcat}}/springmvc3/api/start/start`

# 3. @RequestMapping

**概念：** 注解式处理器映射器会 `@ResquestMapping` 标记的方法进行映射和寻找：
- `value`：设置1或N个方法路由，自动以类上的路由为前缀（若有）：
    - `?`：匹配一个字符，如 `/?/one`。
    - `*`：匹配任意字符，如 `/*/two`。
    - `**`：匹配多层路径，如 `/**/three`。
- `method`：限定1或N种请求方式，值为枚举类 `RequestMethod`：
    - `RequestMethod.GET`：仅接收GET请求，其余请求报错，其余同理。
    - 特殊请求限定方式参考 `z-res/特殊请求限定.md`。
- `params`：限定1或N种请求参数，不满足直接报错：
    - `age/!age`：必须有/没有 `name` 属性，值无所谓。
    - `age=18/age!=18`：必须有 `age=18` 键值对，若有 `age` 则值必须不能为 `18`。

**源码：** /springmvc4/
- src: `c.j.controller.RequestMappingController`
- psm: `{{tomcat}}/springmvc4/api/request-mapping/value-a`
- psm: `{{tomcat}}/springmvc4/api/request-mapping/value-b`
- psm: `{{tomcat}}/springmvc4/api/request-mapping/a/b/user-delete/1`
- psm: `{{tomcat}}/springmvc4/api/request-mapping/method`
- psm: `{{tomcat}}/springmvc4/api/request-mapping/params`

# 4. springmvc接值

**概念：** 因默认值问题，不建议使用任何基本类型接值：
- Cookie参数：对方法参数使用 `@CookieValue` 可以获取Cookie中指定key值信息。
- 请求头参数：对方法参数使用 `@RequestHeader` 可以获取请求头指定key值信息。
- REST参数：对方法参数使用 `@PathVariable` 可以获取方法路由中的指定占位符对应的信息：
    - 路由中需使用 `{}` 标记占位符，对应请求URL的REST参数，与 `@PathVariable` 指定key值同名。
    - REST参数和请求后缀如 `.do` 写法不兼容。
- 键值对简单参数：对方法参数使用 `@RequestParam` 可以获取指定key的键值对请求参数：
    - 简单类型如 `Integer/Float/Double/Boolean/String` 等在同名时可省略注解。
    - 布尔类型对应的请求参数值可使用 `true/false` 或 `1/0`。
    - 允许直接使用实体类统一接收参数，要求实体类属性和参数同名。
    - 允许直接使用数组类型如 `Integer[]` 批量接收同名参数。
- POST中文乱码问题：在web.xml中配置编码过滤器 `o.s.w.f.CharacterEncodingFilter`：
    - 使用 `<init-param>` 注入 `encoding=utf-8`。
    
> 以上注解均可使用 `required` 和 `defaultValue` 设置必填和默认值。
    
**源码：** /springmvc4/
- src: `c.j.controller.ParamController`
- psm: `{{tomcat}}/springmvc4/api/param/cookie-value`
- psm: `{{tomcat}}/springmvc4/api/param/request-header`
- psm: `{{tomcat}}/springmvc4/api/param/path-variable`
- psm: `{{tomcat}}/springmvc4/api/param/request-param`


**源码：** ParamController03.java
```java
/**
 * @author JoeZhou
 */
@Controller
@RequestMapping("param03")
public class ParamController03 {

    @RequestMapping("simpleParam.action")
    public String simpleParam(String username, Integer age) {
        System.out.println(username);
        System.out.println(age);
        return "success";
    }
}
```

模型参数
**源码：** User.java
```java
/**
 * @author JoeZhou
 */
@Data
public class User implements Serializable {
    private Integer id;
    private String name;
}
```

**源码：** ParamController03.java 中添加
```java
@RequestMapping("pojoParam.action")
public String pojoParam(User user1, User user2){
    System.out.println(user1);
    System.out.println(user2);
    return "success";
}
```

> 测试接口：param03/pojoParam.action?name=zhangsan&id=3

数组参数
**源码：** ParamController04.java
```java
/**
 * @author JoeZhou
 */
@Controller
@RequestMapping("param04")
public class ParamController04 {

    @RequestMapping("array.action")
    public String array(Integer[] ids) {
        System.out.println(Arrays.toString(ids));
        return "success";
    }
}
```

> 测试接口：param04/array.action?ids=1&ids=3

# 2. VO模型接收数组参数

**概念：** 
- 数组类型的参数也可以使用VO里的一个 `Integer[]` 属性来接收。
- **什么是VO：** 如果不想破坏POJO的属性结构（不想出现无关属性字段如 `ids`），则可以使用一个VO来存放User以及User相关属性 `ids` 即可，然后：
    - 与前端进行数据交互的时候我们使用VO。
    - 与后端进行交互的时候我们使用POJO。
- 在POJO外套了一层VO之后，前端传值的 `name` 需要发生改变，由原先的直接写POJO属性名，如 `name`，变成 `user.name`，其中 `user` 是VO中的POJO实例的名字。

**源码：** UserVo.java
```java
/**
 * @author JoeZhou
 */
@Data
public class UserVo implements Serializable {
    private User user;
    private Integer[] ids;
}
```

**源码：** ParamController04.java 中添加
```java
@RequestMapping("arrayByVo.action")
public String arrayByVo(UserVo userVo) {
    System.out.println(userVo);
    return "success";
}
```

> 测试接口：param04/arrayByVo.action?ids=1&ids=3&user.name=zhangsan&user.id=18

# 3. 接列表类型参数

**概念：** 
- `List<Pojo>` 类型的接参，常用于批量修改业务，此时不能在动作类方法中直接使用 `List<POJO>` 类型来接收，必须使用一个VO来接收。
- VO中接收的格式为：`List属性名 + 下标 + POJO属性名`，如 `users[0].name`，值随意。

**源码：** UserVo.java 中添加
```java
private List<User> users;
```

**源码：** ParamController04.java 中添加
```java
@RequestMapping("list.action")
public String list(UserVo userVo) {
    System.out.println(userVo.getUsers());
    return "success";
}
```

> 测试：param04/list.action?users[0].name=zhangsan&users[0].id=10&users[1].name=liuneng&users[1].id=2



## 3.2 POST乱码问题

**配置：** web.xml 中添加
```xml
<filter>
    <filter-name>characterEncodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <init-param>
        <param-name>encoding</param-name>
        <param-value>UTF-8</param-value>
    </init-param>
</filter>
<filter-mapping>
    <filter-name>characterEncodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
</filter-mapping>
```
