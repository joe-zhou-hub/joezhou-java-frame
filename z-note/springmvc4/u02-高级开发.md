# 1. 请求参数转换

**概念：** 处理器适配器中可配置自定义类型转换器，用于将请求参数类型转成自定义类型：
- 开发转换器类：实现 `o.s.c.c.c.Converter<A, B>` 接口并重写 `convert()`：
    - 该转换器仅在动作方法使用B类型变量接收A类型请求参数时生效。
- 配置转换器类：主配文件中管理 `o.s.f.s.FormattingConversionServiceFactoryBean`：
    - 注入 `converters`：使用 `<set>` + `<bean>` 注入1或N个转换器类全名。
    - 使用 `<mvc:annotation-driven />` 的 `conversion-service` 引用转换器类。
- 使用转换注解：主配文件中管理 `o.s.f.s.FormattingConversionServiceFactoryBean`：
    - 无需注入 `converters`，否则转换注解失效，仍使用转换器类方式。
    - 使用 `@DateTimeFormat(pattern="")` 标记动作方法参数或实体类属性。
    - 异常信息存放在 `BindingResult` 参数中，其位置必须紧跟爆发异常的那个实体类参数。

**源码：** /springmvc4/
- res: `spring/springmvc.xml`
- src: `c.j.converter.StringToDateConverter`
- src: `c.j.controller.ConverterController`
- psm: `/api/converter/string-to-date`
- psm: `/api/converter/date-time-format`

# 2. 请求参数校验

**概念：** HibernateValidator是JSR303的拓展校验工具，用于校验请求参数是否满足指定格式：
- 添加依赖：`hibernate-validator`。
- 主配中添加 `<mvc:annotation-driven />` 以驱动 `o.s.v.b.LocalValidatorFactoryBean` 校验类。
- 开发实体类：为属性标记HibernateValidator校验注解，多注解优先级从上到下：
    - `@Null/@NotNull`：属性必须为/不为null。
    - `@AssertTrue/@AssertFalse`：属性必须为true/false。
    - `@Min(18)/@Max(18)`：属性必须是最小/大为18的整数。
    - `@DecimalMin(3.5)/@DecimalMax(3.5)`：属性必须是最小/大为3.5的浮点数。
    - `@Size(2, 9)`：属性的必须是2到9之间的一个数。
    - `@Digits (integer, fraction)`：属性必须是一个数字，其值必须在可接受的范围内。
    - `@Past/@Future`：属性必须是一个过去/将来的日期。
    - `@Pattern(value)`：属性必须符合指定的正则表达式。
    - `@Email`：属性必须是合法的电子邮箱地址，JSR303拓展注解。
    - `@Length`：字符串属性的长度必须在指定的范围内，JSR303拓展注解。
    - `@NotEmpty`：字符串/集合/数组属性必须不为null且长度不为0，JSR303拓展注解。
    - `@Range`：属性值必须在指定的范围内，JSR303拓展注解。
- 开发动作类：对动作方法实体类参数标记 `@Valid` 以对其启用HibernateValidator校验。
    - 异常信息存放在 `BindingResult` 参数中，其位置必须紧跟爆发异常的那个实体类参数。

**源码：** /springmvc4/
- res: `spring/springmvc.xml`
- src: `c.j.pojo.Teacher`
- src: `c.j.valid.HibernateValidatorController`
- psm: `/api/valid/hibernate-validator`

# 3. 文件上传

**流程：** 添加依赖 `commons-fileupload`：
- 主配中管理 `o.s.w.m.c.CommonsMultipartResolver`，`id` 固定为 `multipartResolver`：
    - 注入 `maxUploadSize` 以配置上传文件大小限制，单位字节，-1表示无限制。
    - 注入 `maxInMemorySize` 以配置内存最大值使用容量，单位字节。
    - 注入 `defaultEncoding` 以配置文件编码。
- 开发动作类：
    - 方法使用 `@RequestParam("file") MultipartFile/MultipartFile[]` 接收流文件。
    - `file.getOriginalFilename()`：获取文件真实名字。
    - `file.transferTo(File desc)`：将文件对象上传到指定位置。
- 开发视图层：表单添加 `enctype=multipart/form-data` 属性并以POST方式提交。


**配置：** springmvc.xml
```xml

```

**源码：** FileController.java
```java

```

**布局：** upload.html
```html
<form action="/my_springmvc/file/upload.action" 
    method="post" 
    enctype="multipart/form-data">
    
    <label><input type="file" name="srcFile"></label>
    <button type="submit">上传测试</button>
</form>
```

![](https://user-gold-cdn.xitu.io/2020/6/8/17293b29cdf05170?w=1218&h=382&f=png&s=62364 "PostMan上传文件测试图")

# 2. 文件下载

**概念：** 对于下载，使用场景很常见，比如我们项目中有个使用说明是pdf版的，会提供给用户进行下载的功能等。

## 2.1 准备下载源

**概念：** 在计算机的E盘准备一个tx.jpg文件。

## 2.2 动作类

**概念：** 下载的方法返回值必须是 `ResponseEntity<byte[]>`，它是一个响应实体，泛型是字节数组。

**源码：** FileController.java 中添加
```java
@RequestMapping("download.action")
public ResponseEntity<byte[]> download(String filename) throws IOException {
    String path = "C:" + File.separator + "res" + File.separator + filename;
    File file = new File(path);
    HttpHeaders headers = new HttpHeaders();
    headers.setContentDispositionFormData("attachment", filename);
    headers.setContentType(MediaType.APPLICATION_OCTET_STREAM);
    byte[] byteArray = FileUtils.readFileToByteArray(file);
    return new ResponseEntity<>(byteArray, headers, HttpStatus.CREATED);
}
```

> 测试接口：file/download.action?filename=tx.jpg

![](https://user-gold-cdn.xitu.io/2020/6/8/17293b312b93ffed?w=1212&h=220&f=png&s=16294 "PostMan下载文件测试图")