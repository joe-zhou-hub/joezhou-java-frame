# 1. 常量属性DI

**概念：** `<bean>` 的子标签 `<property>` 用于常量属性注入，简单类型如String，Integer等直接使用 `name` 和 `value` 属性进行注入，复杂类型使用其子孙标签配合如下：
- `<array>` + `<value>` 用于注入数组类型属性。
- `<list>` + `<value>` 用于注入 `List` 类型属性。
- `<set>` + `<value>` 用于注入 `Set` 类型属性。
- `<map>` + `<entry>` 用于注入 `Map` 类型属性。
- `<props>` + `<prop>` 用于注入 `Properties` 类型属性。

**源码：** /spring4/
- res: `classpath:spring/di/constant-field.xml`
- src: `c.j.pojo.Emp`
- tst: `c.j.di.DiTest.constantField()`

> 依赖注入时，spring容器寻找的是属性对应的 `set()` 而非属性本身。

# 2. 构造形参DI

**概念：** `<bean>` 的子标签 `<constructor-arg>` 用于构造形参注入，可以替代工厂模式：
- `index`：形参角标，从0开始。
- `value`：对应角标的变量值。
- `type`：对应角标的变量类型，当bean中仅有一个有参构造时可以省略。

**源码：** /spring4/
- res: `classpath:spring/di/constructor.xml`
- src: `c.j.pojo.Manager`
- tst: `c.j.di.DiTest.constructor()`

# 3. 实体类DI

**概念：** 在Service层中注入Dao层的实例有两种方式：
- 外部注入：使用 `<property>` 的 `ref` 引用Dao的 `<bean>` 的id。
- 内部注入：使用 `<property>` 直接包裹Dao的 `<bean>`。

**源码：** /spring4/
- res: `classpath:spring/di/bean-outer.xml`
- res: `classpath:spring/di/bean-inner.xml`
- src: `c.j.dao.CarDao`
- src: `c.j.service.CarService`
- tst: `c.j.di.DiTest.beanOuter()`
- tst: `c.j.di.DiTest.beanInner()`

# 4. 注解方式DI

**概念：** 使用注解进行IOC和DI操作需要配置 `<context:annotation-config/>` 以使得注解生效，此配置相当于一次性对 `org.springframework.beans.factory.annotation` 包中的三个注解处理器类进行了配置：
- `..AutowiredAnnotationBeanPostProcessor` 驱动 `@Autowired`。
- `..RequiredAnnotationBeanPostProcessor` 驱动 `@Required`。
- `..InitDestroyAnnotationBeanPostProcessor` 驱动 `@Resource/@PreDestroy/@PostConstruct`。

> 若核心配置文件不识别 `<context:>`，在头标签中添加 `xmlns:context` 命名空间和两条 `xsi:schemaLocation` 约束文件位置即可。

## 4.1 @Resource注解

**概念：** `@Resource` 是J2EE的注解，与spring无关，该注解直接作用在属性（可以不配置set/get方法）上，以自动注入该属性，以及自动分析该属性与bean的关系：
- `@Resource` 匹配流程：
    - spring容器初始化时，用注解所在的属性名和容器中的所有 `<bean>` 的 `id` 进行匹配。
    - `id` 匹配成功则实例化该bean。
    - `id` 匹配失败，再用注解所在的属性类型的类全名和容器中的所有 `<bean>` 的 `class` 进行匹配。
    - `class` 匹配成功则实例化该bean，注意类与接口的关系也算匹配成功。
    - `class` 匹配失败或匹配到多个，报错。
- `@Resource(name="abc")` 匹配流程：
    - spring容器初始化时，用 `abc` 去和容器中的所有 `<bean>` 的 `id` 进行匹配。
    - `id` 匹配成功则实例化该bean。
    - `id` 匹配失败则直接报错。

**源码：** /spring4/
- res: `classpath:spring/di/dept.xml`
- src: `c.j.dao.DeptDao`
- src: `c.j.service.DeptService`
- tst: `c.j.di.DiTest.deptDao()`

## 4.2 @Autowired注解

**概念：** `@Autowired` 是spring的一个注解，可以对成员属性、属性的 `set()` 上和构造函数上进行标注，来完成自动装配的工作：
- 优先使用 `@Autowired` 所在的属性类型的类全名和容器中的所有 `<bean>` 的 `class` 进行匹配。
    - `class` 匹配成功：new对应的实体类，注意类与接口的关系也算匹配成功。
    - `class` 匹配失败：用注解所在的属性名和容器中的所有 `<bean>` 的 `id` 进行匹配（4.3版本以上支持）。
        - `id` 匹配成功：new对应的实体类。
        - `id` 匹配失败，报错。 
- 如果非要按照 `id` 来匹配，建议配合 `@Qualifier("abc")` 效果更好。

**源码：** CarDao.java
```java
/**
 * @author JoeZhou
 */
public class DogDao {
    public void info() {
        System.out.println("DogDao.info()...");
    }
}
```

**源码：** DogService.java
```java
/**
 * @author JoeZhou
 */
public class DogService {

    private DogDao dogDao;

    @Autowired
    public DogService(DogDao dogDao){
        this.dogDao = dogDao;
    }

    public void info() {
        carDao.info();
    }
}
```

**配置：** spring/di/dog.xml
```xml
<context:annotation-config/>

<!--因使用了@Resource，故无需指定service和dao之间的依赖关系-->
<bean class="com.joezhou.dao.DogDao"/>
<bean class="com.joezhou.service.DogService"/>
```

**源码：** junit测试
```java
@Test
public void dogDao() {
    app = new ClassPathXmlApplicationContext("spring/di/dog.xml");
    app.getBean(CarService.class).info();
    app.close();
}
```

## 4.3 四大注解

**概念：** 
- 为了减轻大spring配置文件中的 `<bean>` 的数量负担，我们可以使用四大注解来替代某些 `<bean>` 的配置。
- 能被扫描到的类必须拥有 `@Component` 标识，`@Controller`、`@Service` 和 `@Repository` 都是  `@Component` 的上层语义化注解。
- 如果是接口实现类的关系，请将注解放在实现类上，因为接口new不了。
-  `@Component` 及其上层三个注解都支持设置 `value` 值来绑定 `<bean>` 的 `id`，如果不设置 `value` 则默认为该类名的首字母小写形式，但如果你的类名是像 `MVCService` 之类的，前几个字母都是大写字母的形式的时候，则 `<bean>` 的 `id` 值仍然是 `MVCService`，首字母不会变成小写。

能被扫描到的注解 | 描述
-|-
`@Controller` | 表示所在类是控制层，会被容器扫描到，无需为其配置 `<bean>`。
`@Service` | 表示所在类是业务层，会被容器扫描到，无需为其配置 `<bean>`。
`@Repository` | 表示所在类是数据层，会被容器扫描到，无需为其配置 `<bean>`。
`@Component` | 表示所在类会被容器扫描到，无需为其配置 `<bean>`。

## 4.4 包扫描

**概念：** 使用注解扫描器来指定扫描范围包及其子包时，也可以隐式地向spring容器注册注解对应的 `Processor`，即此时可以省略 `<context:annotation-config/>` 配置。

**源码：** DogDao.java
```java
/**
 * @author JoeZhou
 */
@Repository
public class DogDao {
    public void talk() {
        System.out.println("wang wang!");
    }
}
```

**源码：** DogService.java
```java
/**
 * @author JoeZhou
 */
@Service
public class DogService {
    private DogDao dogDao;

    @Autowired
    public DogService(DogDao dogDao) {
        this.dogDao = dogDao;
    }

    public void talk() {
        dogDao.talk();
    }
}
```

**配置：** spring/di/app-dog.xml
```xml
<context:component-scan base-package="com.joe.dao"/>
<context:component-scan base-package="com.joe.service"/>
```

**源码：** junit测试
```java
@Test
public void diDogDao() {
    String configLocation = "spring/di/app-dog.xml";
    ClassPathXmlApplicationContext app = new ClassPathXmlApplicationContext(configLocation);
    DogService dogService = app.getBean(DogService.class);
    dogService.talk();
    app.close();
}
```
