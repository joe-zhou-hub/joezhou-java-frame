# 微服务架构概念

**概念：** 
- 对比单体架构：
    - 单体架构开发速度慢，启动时间长，依赖庞大。
    - 微服务架构易开发，理解和维护，独立的部署和启动，但存在分布式事务问题，服务治理问题。
- 微服务核心概念：
    - 网关 `GATWAY`：过滤器 + 路由转发：
        - 过滤器：过滤掉所有不合法的路由。
        - 路由转发：网关可以帮我系统转发路由。
    - 注册中心：服务和服务之间需要互相调用，注册发现流程如下：
        - （注册）A服务启动，A服务向注册中心进行注册登记，表示该服务已经对外开放。
        - （注册）B服务启动，B服务向注册中心进行注册登记，表示该服务已经对外开放。
        - （发现）A服务想要调用B服务，去注册中心中检查到，B服务已开放。
        - 注册中心将B服务的接口地址返回给A服务。
        - A服务调用B服务。
    - 配置中心：存放每个微服务的主配文件，支持动态更新，支持可视化界面，支持同时操作所有服务的配置文件。
    - 链路追踪：分析调用链路节点耗时的一门技术：
        - 链路：比如用户下单的链路：调用商品服务获取商品价格 -> 调用用户服务 -> 调用订单服务...，通过链路追踪分析链路上的哪个过程耗时比较久，以进行精准优化。
    - 负载均衡：进行负载分发，如果集群中的A节点压力过大，则将需求分发到集群中的B节点。
    - 熔断：保护自己，如果链路中的某个节点开了熔断保护（一般是不影响大局的节点才选择开启熔断保护），那么假设这个节点10次调用9次返回失败，，熔断机制会立即放弃这个节点，以保证整条链路的流畅性和速度，然后过一段时间后再重试这个节点。
- 常见微服务框架：需要熟知consumer消费者，provider生产者的两种角色的概念：
    - dubbo：zookeeper + dubbo + springboot
        - [dubbo官网](https://dubbo.apache.org/zh/)
        - 通信方式：rpc（远程方法调用）
        - 注册中心：zookeeper/redis
        - 配置中心：diamond（一款款阿里开源组件）
        - 优点：采用rpc连接，速度快一些。
        - 缺点：框架中的技术模块比较散，需要自己组装。
    - springcloud：[springcloud官网](https://spring.io/projects/spring-cloud)
        - 通信方式：http长连接，restful
        - 注册中心：eureka/consul
        - 配置中心：config
        - 断路器：hystrix
        - 网关：zuul
        - 分布式链路追踪系统：sleuth + zipkin
        - 优点：框架中的技术模块是全家桶套装，整合度非常高。
        - 缺点：http长连接，涉及多次握手，速度低一些。
- 微服务电商模块设计：
    - 用户服务：用户信息接口，登录接口。
    - 商品服务：商品列表，商品详情。
    - 订单服务：我的订单，下单接口。
- 分布式CAP理论：在一个分布式系统中，consistency一致性，availability可用性，partition-tolerance分区容错性，三者不可同时获得：
    - 一致性：在分布式系统中，所有节点通过同步的方式，在同一时间内数据保持完全一致，节点越多，同步越耗时。
    - 可用性：负载过大时，服务也要保持可用，即使响应时间在接受范围内变得慢一些。
    - 分区容错性：即使某些节点崩溃，服务也要保持可用，节点越多，容错性越高。
    - 分区容错性是必须要实现的，其余两个根据情况二选其一，无法共存：
        - CA：数据同步需要时间（满足C），也要正常时间内响应（满足A），那么节点数就必须要减少（不满足P）。
        - CP：节点数量要尽量多（P），数据同步需要时间（满足C），那么响应就会超时（不满足A）。
        - AP：节点数量要尽量多（P），响应不能超时（满足A），那么数据不能及时同步（不满足C）。






- 注册中心：用表格的方式来管理和维护服务集群：
    - 每个服务集群在启动时都应该向注册中心注册自己的节点网络信息（IP，端口等），对外接口信息等。
    - 用心跳机制来检测服务集群中的节点存活状态：每隔一段时间，集群中的节点都会ping一次注册中心，表示自己还活着，如果长时间没有ping，则表示节点已挂。
    - 注册中心的最大作用就是对大批量的服务之间的调用过程进行解耦。
    - 主流注册中心：zookeeper，eureka，consul，etcd等。
        - zookeeper：CP设计，有主从节点，如果主节点挂了，会进行内部投票选举新的主节点，此时不能对外提供服务，且如果半数以上节点不可用时，也无法对外提供服务，可见它无法满足可用性A，一般部分金融行业会选择。
        - eureka：AP原则，无主从节点，一个节点挂了，会自动切换另一个节点，去中心化，以效率为主，不保证数据一致性，一般部分电商系统会选择。
        - AP是主流选择。
- eureka：springcloud的核心组件，奈飞（Netflix）旗下的产品，2.x版本已经闭源了。
    - Server：服务端维护一个服务集群列表。
    - Client：每个服务节点都会嵌入一个eureka客户端（Jar包），通过它跟eureka服务端交互。








