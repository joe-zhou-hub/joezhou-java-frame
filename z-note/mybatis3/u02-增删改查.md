# 1. SQL配置文件

**概念：** SQL配置文件用于配置SQL语句块以及SQL相关配置：
- 开发实体类：与数据库表形成ORM关系：
    - 数据库主键若无符号，则实体类中建议使用Integer类型与之对应。
    - 数据库住家若有符号，则实体类中建议使用Long类型与之对应。
- 开发SQL配置文件：
    - 必须配置根标签 `<mapper>` 的 `namespace` 以隔离语句。 
    - 每个SQL语句块中的SQL语句末尾是否使用分号对结果并无影响。
    - 每个SQL语句块中用于指定参数类型的 `parameterType` 属性均可省略。
- 配置SQL配置文件：在核心配置文件中使用 `<mappers resource="">` 引入：
    - 路径从classpath出发，且不以 `/` 开头。
- 取消IDEA中SQL语句黄绿色背景：`File` - `Settings`：
    - `Inspections` - `SQL` - 取勾 `No data sources configured` 和 `SQL dialect detection`。
    - `Color Scheme` - `General` - `Code` - `Injected language fragment` - 取勾 `Background`。

**源码：** /mybatis3/
- res: `classpath:mybatis-crud.xml`
- res: `classpath:mapper/student-mapper.xml`
- res: `classpath:mapper/worker-mapper.xml`
- res: `classpath:mapper/teacher-mapper.xml`
- src: `c.j.pojo.Student`
- src: `c.j.pojo.Worker`
- src: `c.j.pojo.Teacher`

# 2. DML语句块

**流程：** DML操作均没有返回值，必须省略 `resultType`：
- 开发 `<insert id="insert">`：单表添加普通版语句块：
    - `useGeneratedKeys="true"`：启用主键回注机制。
    - `keyProperty="id"`：指定主键回注到哪个字段中。
- 开发 `<insert id="insertWithSelectKey">`：单表添加SelectKey版语句块：
    - `<selectKey>`：设置子语句块，伴随 `<insert>` 一同执行。
    - `order="BEFORE"`：设置子语句块在 `<insert>` 语句之前执行。
    - `keyProperty="id"`：设置子语句块的查询结果回注到 `id` 字段中。
    - `resultType`：指定回注字段的类全名，不可省略。
    - `SELECT last_insert_id()`：返回最后一条插入记录的注解。
    - `SELECT uuid()`：返回一个随机字符串。
- 开发 `<update id="updateById">`：单表修改语句块。
- 开发 `<delete id="deleteById">`：单表删除语句块。
- 开发SQL语句： 支持占位符 `#{}` 时，自动补充单引号：
    - 参数若为实体类，则占位符中必须为实体类中对应属性名，支持多级连调。
    - 参数若为简单类，则占位符中内容可以随意填写，但不能不写。
- 测试：
    - `session.insert("命名空间.SQL语句块ID", 入参)`：添加数据。
    - `session.update("命名空间.SQL语句块ID", 入参)`：修改数据。
    - `session.delete("命名空间.SQL语句块ID", 入参)`：删除数据。

**源码：** /mybatis3/
- res: `classpath:mapper/student-mapper.xml`
- tst: `c.j.crud.StudentTest.insert()`
- tst: `c.j.crud.StudentTest.insertWithSelectKey()`
- tst: `c.j.crud.StudentTest.updateById()`
- tst: `c.j.crud.StudentTest.deleteById()`

# 3. DQL语句块

**流程：** DQL操作需使用 `resultType` 指定返回值或返回值泛型的类全名或别名：
- 开发 `<select id="findById">`：单表单查语句块。
- 开发 `<select id="findLikeName">`：单表多查拼接符版语句块。
- 开发 `<select id="findLikeNameWithConcat">`：单表多查占位符版语句块。
- 开发SQL语句：支持拼接符 `${value}` 时，不会自动补充单引号，有注入漏洞：
    - 参数若为实体类，则占位符中必须为实体类中对应属性名，支持多级连调。
    - 参数若为简单类，则占位符中内容必须是 `value`。
- SQL注入漏洞：此WEB漏洞的本质是将用户输入的数据当做代码执行以攻击系统：
    - `like '%${value}%'`：有漏洞，若攻击者传入 `'or'` 时会直接执行全查。
    - `like concat('%', #{name}, '%')`：无注入漏洞问题。
- DQL语句块其他属性：
    - `resultMap`：引用 `<resultMap>` 的id 名，不能与 `resultType` 同时使用。 
    - `flushCache`：每次调用该语句块前是否清空其缓存以保证结果最新，默认 `false`。
    - `useCache`：该语句块的结果集是否会被缓存，默认 `true`。
    - `timeout`：语句块超时时间，默认数值由驱动器决定。
    - `fetchSize`：结果集条目数达到此阈值时立刻返回结果，默认数值由驱动器决定。
    - `statementType`：SQL媒介类型默认为预处理 `PREPARED`，可改为不预处理 `STATEMENT` 或存储过程 `CALLABLE`。
- 测试：
    - `session.selectOne("命名空间.SQL语句块ID", 入参)`：查询单条数据。
    - `session.selectList("命名空间.SQL语句块ID", 入参)`：查询多条数据。

**源码：** /mybatis3/
- res: `classpath:mapper/student-mapper.xml`
- tst: `c.j.crud.StudentTest.selectOne()`
- tst: `c.j.crud.StudentTest.findLikeName()`
- tst: `c.j.crud.StudentTest.findLikeNameWithConcat()`

# 4. 接口开发

**流程：** 接口动态代理模式需要额外开发一个遵守对应关系的java接口：
- 四大对应：
    - 接口类全名对应SQL配置文件的 `namespace`。
    - 接口方法返回值类型对应SQL语句块的 `resultType`。
    - 接口方法方法名对应SQL语句块的 `id`。
    - 接口方法形参对应SQL语句块的 `parameterType`。
- 测试：`session.getMapper()`：获取接口对象后直接调用接口方法。

**源码：** /mybatis3/
- res: `classpath:mapper/worker-mapper.xml`
- src: `c.j.mapper.WorkerMapper`
- tst: `c.j.crud.WorkerTest`

# 5. 注解开发

**流程：** 接口开发模式下，可使用注解替代SQL语句块，虽简化了代码，但不适用于复杂SQL：
- 开发SQL配置文件：即使不写SQL语句块，`namespace` 仍要对应接口类全名。
- 开发接口：在接口方法上直接使用注解来完成SQL的编写：
    - `@Select(value = "")`：编写查询SQL。
    - `@Insert(value = "")`：编写添加SQL。
    - `@Update(value = "")`：编写修改SQL。
    - `@Delete(value = "")`：编写删除SQL。
    - `@Options`：配置缓存，超时时间，主键回注等。

**源码：** /mybatis3/
- res: `classpath:mapper/teacher-mapper.xml`
- src: `c.j.mapper.TeacherMapper`
- tst: `c.j.crud.TeacherTest`