# 1. 整合准备

**流程：** 
- 添加依赖：
    - mybatis/mysql-connector-java/commons-dbcp2
    - spring-core/spring-beans/spring-aspects/spring-tx/spring-jdbc
    - spring-context/spring-context-support/spring-expression
    - log4j-core/log4j/slf4j-api/slf4j-log4j12
    - lombok/junit/spring-test/mybatis-spring
- 开发对应小狗表的小狗实体类。
- 开发mybatis主配文件：配置别名，SQL配置文件扫描和数据源交给spring做。

**源码：** /mybatis3/
- res: `pom.xml`
- res: `classpath:mybatis-sm.xml`
- src: `c.j.pojo.Dog`
- src: `c.j.pojo.Cat`

# 2. 原生DAO整合

**流程：**
- 开发SQL配置文件：编写CRUD语句块，不使用接口所以无需四大对应。
- 开发数据层接口和实现类：继承SM整合包中的 `SqlSessionDaoSupport`：
    - `getSqlSession()`：获取一个spring管理的session对象，不支持手动提交回滚和关闭。
- 开发spring主配文件并加载属性文件：
    - `<context:property-placeholder location="classpath:属性文件">`
- 在spring主配文件中IOC连接池 `o.a.c.d.BasicDataSource`：
    - 将驱动串等数据源信息DI给DBCP连接池的对应属性。
- 在spring主配文件中IOC会话工厂 `o.m.s.SqlSessionFactoryBean`：
    - 将mybatis的主配文件DI给 `configLocation` 属性。
    - 将连接池DI给 `dataSource` 属性。
    - 将SQL配置文件DI给 `mapperLocations` 属性。
- 在spring主配中IOC数据层实现类：
    - 将会话工厂DI给 `sqlSessionFactory` 属性（其父类的SET方法）。

**源码：** /mybatis3/
- res: `classpath:c.j.mapper.DogMapper.xml`
- res: `classpath:sprint/spring-dog.xml`
- src: `c.j.dao.DogDao`
- src: `c.j.dao.impl.DogDaoImpl`
- tst: `c.j.sm.DogTest`

# 3. 接口Mapper整合

**流程：**
- 开发SQL配置文件：编写CRUD语句块，需要和接口四大对应。
- 开发Mapper接口，建议与SQL配置文件同名同包。
- 开发spring主配文件并加载属性文件：
    - `<context:property-placeholder location="classpath:属性文件">`
- 在spring主配文件中IOC连接池 `o.a.c.d.BasicDataSource`：
    - 将驱动串等数据源信息DI给DBCP连接池的对应属性。
- 在spring主配文件中IOC会话工厂 `o.m.s.SqlSessionFactoryBean`：
    - 将mybatis的主配文件DI给 `configLocation` 属性。
    - 将连接池DI给 `dataSource` 属性。
    - 将SQL配置文件DI给 `mapperLocations` 属性，接口和配置文件同名同包时可省略。
- 在spring主配文件中IOC接口扫描类 `o.m.s.m.MapperFactoryBean`：
    - 将接口类全名DI给 `mapperInterface` 属性。
    - 将会话工厂DI给 `sqlSessionFactory` 属性。
- 在spring主配文件中IOC接口包扫描类 `o.m.s.m.MapperScannerConfigurer`：
    - 将接口所在包名DI给 `basePackage` 属性。
    - 包中所有接口的 `<bean>` 的id都默认为接口名首字母小写。
- 在spring主配文件中IOC单个接口 `o.m.s.m.MapperFactoryBean`：
    - 将接口全名DI给 `mapperInterface` 属性。
    - 将会话工厂DI给 `sqlSessionFactory` 属性。
    - 此方法与接口包扫描方法不共存。

**源码：** /mybatis3/
- res: `classpath:c.j.mapper.CatMapper.xml`
- res: `classpath:sprint/spring-cat.xml`
- src: `c.j.mapper.CatMapper`
- tst: `c.j.sm.CatTest`

# 4. 逆向工程

**概念：** mybatis逆向工程用于根据数据表生成对应的实体类，包含CRUD语句块的SQL配置文件，对应SQL配置文件的Mapper接口，mybatis主配置文件等，仅支持单表：
- 添加依赖：
    - mybatis/mybatis-generator-core/mysql-connector-java
- 开发逆向工程主配文件：放在工程的根目录下，而非classpath下：
    - `<plugin>`：配置逆向工程插件，如序列化，`toString()` 等。
    - `<commentGenerator>`：配置是否添加工程注释。
    - `<jdbcConnection>`：配置JDBC连库信息。
    - `<javaTypeResolver>`：配置实体类个别属性类型解析规则。
    - `<javaModelGenerator>`：配置实体类生成位置。
    - `<sqlMapGenerator>`：配置SQL配置文件生成位置。
    - `<javaClientGenerator>`：配置Mapper接口生成位置。
    - `<table>`：配置根据哪些数据库表生成信息。
- 开发主类并使用main方法运行逆向工程：再次生成时要先将之前生成的所有文件删除，否则信息叠加。

**源码：** /mybatis3-generator/
- res: `pom.xml`
- res: `generator.xml`
- src: `c.j.app.Generator`

## 4.1 插入API

**概念：** 
- `insert()`：缺省字段注入null，不会使用动态SQL，性能低。
- `insertSelective()`：缺省字段被忽略，结果仍为null，使用动态SQL，性能高。

**源码：** /mybatis3-generator/
- res: `classpath:mybatis-generator.xml`
- tst: `c.j.generator.UserTest`

## 4.2 查询API

**概念：** 
- `selectByPrimaryKey()`：通过主键查询信息。
- `selectByExample()`：通过条件查询信息：
    - `new UserExample()`：创建对应实体类的条件对象。
    - `example.createCriteria().条件()`：设置条件，不设置视为全查。
    - `mapper.selectByExample(example)`：将条件对象作为查询参数。
- `countByExample()` 可以按照条件查询符合条件的数据的条目数。
- 条件对象API：
    - `example.setOrderByClause()` 可以对结果集进行排序。
    - `example.setDistinct()`：对结果集去重。
    - `example.setOrderByClause()`：对结果集进行排序。

**源码：** junit测试
```java
@Test
public void selectByPrimaryKey(){
    System.out.println(userMapper.selectByPrimaryKey(7));
}

/*按条件查询：查询姓赵的男性*/
@Test
public void selectByExample() {
    UserExample example = new UserExample();
    UserExample.Criteria criteria = example.createCriteria();
    criteria.andNameLike("赵%");
    criteria.andGenderEqualTo("男");
    System.out.println(userMapper.selectByExample(example));
}

@Test
public void select() {
    System.out.println(userMapper.selectByExample(new UserExample()));
}

/**查询id大于等于2的人数有多少*/
@Test
public void countByExample() {
    UserExample example = new UserExample();
    example.createCriteria()
            .andIdGreaterThanOrEqualTo(2);
    int count = userMapper.countByExample(example);
    System.out.println(count);
}

@Test
public void setOrderByClause() {
    UserExample example = new UserExample();
    example.setOrderByClause("age desc");
    List<User> users = userMapper.selectByExample(example);
    System.out.println(users);
}

@Test
public void setDistinct() {
    UserExample example = new UserExample();
    example.setDistinct(false);
    List<User> users = userMapper.selectByExample(example);
    System.out.println(users);
}

/*找到年龄为null，或者年龄是10,20,30岁的用户*/
@Test
public void selectByOr(){
    List<Integer> ages = new ArrayList<>();
    ages.add(10);
    ages.add(20);
    ages.add(30);
    UserExample example = new UserExample();
    example.or().andAgeIsNull();
    example.or().andAgeIn(ages);
    List<User> users = userMapper.selectByExample(example);
    System.out.println(users);
}
```

## 4.3 修改API

**概念：** 
- `updateByPrimaryKey()` 在全部完整信息修改时调用。
    - 使用 `updateByPrimaryKey()` 修改时，如果少设置一个字段，则该字段会被注入 `null`。
- `updateByPrimaryKeySelective()` 在部分信息修改(选择性修改)时调用。
    - 使用 `updateByPrimaryKeySelective()` 修改时，如果少设置一个字段，该字段的修改过程会被忽略，即保留原值。
- `updateByExample()` 在全部完整信息修改时调用。
    - 使用 `updateByExample()` 修改时，如果少设置一个字段，则该字段会被注入 `null`。
- `updateByExampleSelective()` 在部分信息修改(选择性修改)时调用。
    - 使用 `updateByExampleSelective()` 修改时，如果少设置一个字段，该字段的修改过程会被忽略，即保留原值。

**源码：** junit测试
```java
@Test
public void updateByPrimaryKey(){
    User user = new User();
    user.setId(1);
    user.setName("赵四儿");
    user.setGender("男");
    userMapper.updateByPrimaryKey(user);
}

@Test
public void updateByPrimaryKeySelective() {
    User user = new User();
    user.setId(1);
    user.setName("赵四");
    userMapper.updateByPrimaryKeySelective(user);
}

@Test
public void updateByExample() {
    UserExample example = new UserExample();
    example.createCriteria()
            .andNameEqualTo("赵四");
    User user = new User();
    user.setName("赵老四");
    user.setAge(88);
    userMapper.updateByExampleSelective(user, example);
}

@Test
public void updateByExampleSelective() {
    UserExample example = new UserExample();
    example.createCriteria()
            .andNameEqualTo("赵老四");
    User user = new User();
    user.setName("赵国强");
    userMapper.updateByExampleSelective(user, example);
}
```

## 4.4 删除API

**概念：** 
- `deleteByPrimaryKey()` 按照主键删除信息。
- `deleteByExample()` 按照条件删除。

**源码：** junit测试
```java
@Test
public void deleteByPrimaryKey(){
    int id = 1;
    userMapper.deleteByPrimaryKey(id);
}

@Test
public void deleteByExample() {
    UserExample example = new UserExample();
    example.or().andAgeIsNull();
    example.or().andAgeBetween(18, 40);
    userMapper.deleteByExample(example);
}
```
