# 1. 基本概念

**概念：** mybatis是一个底层封装了JDBC的持久层的开源框架，前身是apache的ibatis项目，10年迁移到了google-code并改名为mybatis，13年11月迁移到github：
- ORM：Object Relation Mapping 希望通过操作java对象的方式来操作数据库：
    - `class-name` 对应 `table-name`。
    - `field-name` 对应 `column-name`。
    - `field-type` 对应 `column-type`。
    - `instance` 对应 `record`。
- 特点：
    - mybatis是半封装ORM框架，封装了驱动，连接，statement等业务代码，但不封装SQL语句。
    - mybatis支持注解或XML方式单独开发SQL语句，与java代码解耦，方便后期优化。
    - mybatis可以将java对象映射到SQL中，也可以将SQL结果映射成java对象。
- vs hibernate：框架没有最好，只有最合适：
    - mybatis半封装ORM框架，hibernate全封装ORM框架。
    - mybatis开发周期长，hibernate开发周期短。
    - mybatis数据库相关，切换数据库时需要重构SQL与，hibernate数据库无关。
    - mybatis适合高QPS系统，如互联网软件，企业运营，电商，P2P等，hibernate适合低QPS系统，如oa办公自动化，erp企业流程系统，某些政府项目等。

# 2. 核心流程

**概念：** 
- `SqlSessionFactoryBuilder`：用于创建 `SqlSessionFactory` 对象的类：
    - 创建 `SqlSessionFactory` 时需以读取核心配置文件。
    - 核心配置文件用于配置mybatis的环境信息和SQL配置文件路径。
    - SQL配置文件用于配置CRUD语句块和SQL语句相关配置信息。
- `SqlSessionFactory`：用于获取 `SqlSession` 对象的接口。
- `SqlSession`：用于获取数据库连接的接口。
- `Executor`：`SqlSession` 中的SQL执行者，负责SQL执行，有基本和缓存两种执行器实现。
- `MappedStatement`：`Executor` 中的SQL管理者，负责SQL组装和结果转换：
    - 每个SQL块都通过id属性对应一个SQL管理者对象。
    - 输入映射：在执行SQL前，将输入的java对象参数映射至SQL中。
    - 输出映射：在执行SQL后，将SQL结果映射到指定的java对象中。

# 3. 基本配通

**概念：** [mybatis下载地址](https://github.com/mybatis/mybatis-3/releases)
- 数据库：创建mybatis数据库，mybatis用户，和Student表。
- 添加依赖：
    - mybatis/ant/asm/cglib/commons-logging/ognl
    - log4j-core/log4j/slf4j-api/slf4j-log4j12
    - mysql-connector-java/lombok/junit
    - oracle数据库需要导入 `ojdbc6.jar`。
- 开发实体类：对应数据库表。
- 开发SQL配置文件：
    - `<mapper>`：SQL配置文件最根标签，必须使用 `namespace` 属性指定命名空间以隔离语句。 
- 开发核心配置文件：
    - `<environments>`：环境根标签，使用 `default` 属性指向当前环境。
    - `<environment>`：环境标签，多环境使用 `id` 进行区分。
    - `<transactionManager>`：用于配置该环境下的事务管理类。
    - `<dataSource>`：用于配置该环境的数据源信息，使用 `type` 属性来指定连接池类。
    - `<mappers>`：用于引入SQL配置文件，路径从classpath出发，且不以 `/` 开头。
- 开发日志文件：mybatis默认使用log4j日志，自动读取 `classpath:log4j.properties` 日志文件。
- 测试：
    - `Resources.getResourceAsStream/Reader()`：获取核心配置文件的字节/符流对象。
    - `new SqlSessionFactoryBuilder()`：创建一个会话工厂的builder对象。
    - `builder.build()`：根据核心配置文件创建会话工厂。
    - `factory.openSession()/(true)`：从会话工厂中打开一个具有/不具有事务保护的会话。
    - `session.getConnection().isClosed()`：通过会话获取一个连接并测试状态。 
    - `session.close()`：关闭会话，可由 `try-with-resource` 异常结构完成。

**源码：** /mybatis3/
- res: `README.md`
- res: `mybatis.sql`
- res: `pom.xml`
- res: `classpath:mapper/StudentMapper.xml`
- res: `classpath:mybatis-student.xml`
- res: `classpath:log4j.propeties`
- src: `c.j.pojo.Student`
- tst: `c.j.start.StudentTest.start()`

## 3.1 事务管理类

**概念：** mybatis提供了两种事务管理类，对应别名如下：
    - `JDBC`：简单的使用了JDBC的提交和回滚，它依赖于从数据源得到的连接来管理事务。
    - `MANAGED`：几乎什么都没做，它从来不会提交和回滚一个连接，它依赖于第三方容器，如spring来对事物进行管理。

## 3.2 数据源类

**概念：** mybatis提供了三种数据源类，对应别名如下：
- `UNPOOLED`：未使用连接池，只实现了简单的打开连接和关闭连接，速度比较慢，它有五种属性：
    - `driver`：驱动串
    - `url`：连接串
    - `username`：账号
    - `password`：密码
    - `defaultTransactionIsolationLevel`：默认连接的事务隔离级别
- `POOLED`：使用了连接池，这种类型的数据源是很流行的一种，它除了上面5个属性外，还有以下几种额外属性：
    - `poolMaximumActiveConnections`：活跃（正在使用）的连接的数量，默认为10
    - `poolMaximumIdleConnections`：空闲连接数
    - `poolMaximumCheckoutTime`：在被强制返回之前，池中连接被检查的时间，默认为20000毫秒
    - `poolTimeToWait`：一个连接的最长等待时间，默认20000毫秒
    - `poolPingQuery`：发送到数据的侦测查询，主要是为了验证一下连接是否还活着，默认是 `NO PING QUERY SET`
    - `poolPingEnabled`：开启或关闭侦测查询，如果开启，你必须使用一个合法的SQL语句（最快的）来设置 `poolPingQuery` 的值，默认false
    - `poolPingConnectionsNotUsedFor`：发送侦测查询的周期时间，即多久发送一次侦测查询，默认为0（每一刻都侦测），该属性仅当开启侦测查询的情况下生效
- `JNDI`：这个数据源的实现是为了使用如spring这样的容器，它只有2个属性
    - `inital_context`：这个属性用来从上下文中寻找环境
    - `data_source`：引用数据源实例的实际位置

# 4. 工具类封装

**概念：** 
- 核心对象生命周期：
    - `SqlSessionFactoryBuilder`：创建完会话工厂实例后即可销毁，建议设置为局部变量。
    - `SqlSessionFactory`：可以重复使用，但不该被重复创建，建议以单例模式来管理。
    - `SqlSession`：每个线程都该独享一个会话实例，建议设置为局部变量。
- 会话工厂创建方式：
    - `build(InputStream is)`
    - `build(InputStream is, String env)`
    - `build(InputStream is, Properties prop)`
    - `build(InputStream is, String env, Properties prop)`

**源码：** /mybatis3/
- res: `jdbc/properties`
- res: `mybatis-student.xml`
- src: `c.j.util.MyBatisUtil`
- tst: `c.j.start.StudentTest.myBatisUtil()`
- tst: `c.j.start.StudentTest.myBatisUtilWithEnv()`
- tst: `c.j.start.StudentTest.myBatisUtilWithProp()`
- tst: `c.j.start.StudentTest.myBatisUtilWithEnvAndProp()`

# 5. 属性文件

**概念：** 除了在在创建会话工厂时引入 `properties` 文件外，还可以在核心配置文件中使用 `<properties resource="">` 引入属性文件。

**源码：** /mybatis3/
- res: `classpath:mybatis-student-props.xml`
- tst: `c.j.start.StudentTest.configPropertiesWithXml()`

