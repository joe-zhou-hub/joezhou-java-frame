# 1. 基本概念

**概念：** mybatis是一个底层封装了JDBC的持久层的开源框架，前身是apache的ibatis项目，10年迁移到了google-code并改名为mybatis，13年11月迁移到github：
- ORM：Object Relation Mapping 希望通过操作java对象的方式来操作数据库：
    - `class-name` 对应 `table-name`。
    - `field-name` 对应 `column-name`。
    - `field-type` 对应 `column-type`。
    - `instance` 对应 `record`。
- 特点：
    - mybatis是半封装ORM框架，封装了驱动，连接，statement等业务代码，但不封装SQL语句。
    - mybatis支持注解或XML方式单独开发SQL语句，与java代码解耦，方便后期优化。
    - mybatis可以将java对象映射到SQL中，也可以将SQL结果映射成java对象。
- vs hibernate：框架没有最好，只有最合适：
    - mybatis半封装ORM框架，hibernate全封装ORM框架。
    - mybatis开发周期长，hibernate开发周期短。
    - mybatis数据库相关，切换数据库时需要重构SQL与，hibernate数据库无关。
    - mybatis适合高QPS系统，如互联网软件，企业运营，电商，P2P等，hibernate适合低QPS系统，如oa办公自动化，erp企业流程系统，某些政府项目等。

# 2. 核心流程

**概念：** 
- `SqlSessionFactoryBuilder`：用于创建 `SqlSessionFactory` 对象的类：
    - 创建 `SqlSessionFactory` 时需以读取核心配置文件。
    - 核心配置文件用于配置mybatis的环境信息和SQL配置文件路径。
    - SQL配置文件用于配置CRUD语句块和SQL语句相关配置信息。
- `SqlSessionFactory`：用于获取 `SqlSession` 对象的接口。
- `SqlSession`：用于获取数据库连接的接口。
- `Executor`：`SqlSession` 中的SQL执行者，负责SQL执行，有基本和缓存两种执行器实现。
- `MappedStatement`：`Executor` 中的SQL管理者，负责SQL组装和结果转换：
    - 每个SQL块都通过id属性对应一个SQL管理者对象。
    - 输入映射：在执行SQL前，将输入的java对象参数映射至SQL中。
    - 输出映射：在执行SQL后，将SQL结果映射到指定的java对象中。

# 3. 基本配通

**概念：** [mybatis下载地址](https://github.com/mybatis/mybatis-3/releases)
- 数据库：创建mybatis数据库，mybatis用户，和Student表。
- 添加依赖：
    - mybatis/ant/asm/cglib/commons-logging/ognl
    - log4j-core/log4j/slf4j-api/slf4j-log4j12
    - mysql-connector-java/lombok/junit
    - oracle数据库需要导入 `ojdbc6.jar`。
- 开发实体类：对应数据库表。
- 开发SQL配置文件：
    - `<mapper>`：SQL配置文件最根标签，必须使用 `namespace` 属性指定命名空间以隔离语句。 
- 开发核心配置文件：
    - `<environments>`：环境根标签，使用 `default` 属性指向当前环境。
    - `<environment>`：环境标签，多环境使用 `id` 进行区分。
    - `<transactionManager>`：用于配置该环境下的事务管理类。
    - `<dataSource>`：用于配置该环境的数据源信息，使用 `type` 属性来指定连接池类。
    - `<mappers>`：用于引入SQL配置文件，路径从classpath出发，且不以 `/` 开头。
- 开发日志文件：mybatis默认使用log4j日志，自动读取 `classpath:log4j.properties` 日志文件。
- 测试：
    - `Resources.getResourceAsStream()`：获取核心配置文件的字节流对象。
    - `Resources.getResourceAsReader()`：获取核心配置文件的字符流对象。
    - `new SqlSessionFactoryBuilder()`：创建一个会话工厂的builder对象。
    - `builder.build()`：根据核心配置文件创建会话工厂。
    - `factory.openSession()`：从会话工厂中打开一个具有事务保护的会话。
    - `factory.openSession(true)`：从会话工厂中打开一个无事务保护的会话。
    - `session.getConnection().isClosed()`：通过会话获取一个连接并测试状态。 
    - `session.close()`：关闭会话，可由 `try-with-resource` 异常结构完成。

**源码：** /mybatis3/
- res: `README.md`
- res: `mybatis.sql`
- res: `pom.xml`
- res: `classpath:mapper/StudentMapper.xml`
- res: `classpath:mybatis-student.xml`
- res: `classpath:log4j.propeties`
- src: `c.j.pojo.Student`
- tst: `c.j.start.StudentTest.start()`

# 4. 工具类封装

**概念：** 
- `SqlSessionFactoryBuilder`：创建完会话工厂实例后即可销毁，建议设置为局部变量。
- `SqlSessionFactory`：可以重复使用，但不该被重复创建，建议以单例模式来管理。
- `SqlSession`：每个线程都该独享一个会话实例，建议设置为局部变量。

**源码：** /mybatis3/
- src: `c.j.util.MyBatisUtil`
- tst: `c.j.start.StudentTest.myBatisUtil()`


