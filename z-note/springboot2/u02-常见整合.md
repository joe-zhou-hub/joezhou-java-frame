# 1. 整合logback

**概念：** `spring-boot-starter` 依赖中包含了 `spring-boot-starter-logging` 依赖，即springboot默认使用logback作为日志框架，它是log4j的改进版，不能单独使用，推荐配合slf4j一起使用，核心对象有三个：
- `Logger`：日志记录器，负责记录日志。
- `Appender`：日志追加器，指定日志输出位置。
- `Layout`：日志布局器，指定日志信息的格式。

**流程：**
- 开发日志配置文件：springboot默认加载 `classpath:logback.xml` 或 `classpath:logback-spring.xml`：
    - 自定义日志配置文件需要在主配文件中指定：`logging.config=classpath:my-log.xml`。
- 配置控制台日志追加器 `<appender name="STDOUT" class="c.q.l.c.ConsoleAppender>`：
    - `<encoder>` + `<pattern>/<charset>`：配置日志格式/字符集。
- 配置文件日志追加器 `<appender name="WARN" class="c.q.l.c.r.RollingFileAppender">`：
    - `<encoder>` + `<pattern>/<charset>`：配置日志格式/字符集。
    - `<file>` 指定了日志文件路径，默认位置相对于项目，支持使用绝对路径。
    - `<append>`：设置是否追加日志，默认为true。
- 在日志配置文件中配置根记录器 `<root>`：建议放在最后：
    - 属性 `level` 用于指定最低日志级别，TRACE < DEBUG < INFO < WARN < ERROR < ALL，不区分大小写。
    - 子标签 `<appender-ref>` 使用 `ref` 属性关联某个追加器名，表示使用该追加器，可存在0或多个。
- 开发动作类：
    - `Logger logger = LoggerFactory.getLogger(getClass())`：获取当前类的日志记录器。
    - `logger.debug/info/warn/error("")`：记录一条DEBUG/INFO/WARN/ERROR级别的日志信息。

> z-res/logback日志格式占位符.md

**源码：** /springboot2/
- res: `classpath:my-log.xml`
- src: `c.j.s.controller.LogBackController`
- psm: `api/logback/test`

`<filter class="ch.qos.logback.classic.filter.ThresholdFilter">`：阈值过滤器
    - <level>：来指定日志等级，必须等于或大于该等级，才会记录日志。
`<filter class="ch.qos.logback.classic.filter.LevelFilter">`：等级过滤器
    - <level>：指定日志等级。
    <onMatch>：命中了指定的日志等级后的操作：
        DENY：表示阻止记录该条日志。
        ACCEPT：表示允许记录该条日志。
    <onMissMatch>：未命中指定的日志等级后的操作：
        DENY：表示阻止记录该条日志。
        ACCEPT：表示允许记录该条日志。

<filter>：日志等级过滤器，常用的有两种：

<rollingPolicy class="c.q.l.c.r.SizeAndTimeBasedRollingPolicy">
<rollingPolicy>：设置滚动策略


策略内容为：先按照日期，将日志记录到日志文件中，如 `a.log`
- 若日期变化，将前一天的日志文件重命名为 a.2020-01-01.0.log，格式固定为文件名 + 日期 + 拆分索引。
原日志文件重命名后，新日志文件名字仍使用 my.log。
- 若日期未变，但日志大小超过某个设定值，如100M，则对日志进行分割，如将 my.log 拆为 my + 日期 + 1.log 和 my + 日期 + 2.log。
<rollingPolicy> 有四个子标签：
<fileNamePattern>：log/warn.%d.%i.log</fileNamePattern>
<maxHistory>：设置每产生一个日志文件，该日志文件最多保存多久，该值的单位是根据 <fileNamePattern> 的值自动推算的：
如 <fileNamePattern> 中选用了 yyyy-MM-dd，则单位为天。
如 <fileNamePattern> 中选用了 yyyy-MM，则单位为月。
<totalSizeCap>：日志最大限制，数值需要加单位，超出此值立刻删除多余日志。
<maxFileSize>：日志切分阈值，默认值是10MB，数值需要加单位，文件超过这个阈值时开始切分。
<logger>：负责追踪运行时日志（不包括启动日志），使用子标签 <appender-ref> 来指定具体的Appender。
name：指定包名。
level：指定最低日志级别。

3.1 配置

需求： 只将WRAN信息输出在 /log/warn.log 文件中。

配置： logback-spring.xml

<?xml version="1.0" encoding="UTF-8"?>
<configuration>


    <!--文件日志Appender-->
    <appender name="WARN" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>log/warn.log</file>
        <append>true</append>

        <!--过滤器：不记录ERROR，只记录WARN-->
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>DENY</onMatch>
            <onMismatch>ACCEPT</onMismatch>
        </filter>

        <!--滚动策略-->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>log/warn.%d.%i.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
            <maxFileSize>10MB</maxFileSize>
        </rollingPolicy>

        <!--编码器-->
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p - [%4.10(%t)] %c{50}.%M:%L : %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>

    </appender>

    <!--日志记录器-->
    <logger name="com.joe.app.controller" level="WARN">
        <appender-ref ref="WARN"/>
    </logger>

    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>

</configuration>
文件日志不支持 %highlight() 或 %cyan() 之类的颜色属性词。