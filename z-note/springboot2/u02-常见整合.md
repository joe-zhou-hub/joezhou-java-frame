# 1. 整合logback

**概念：** springboot支持 `common-logging`，`log4j`，`slf4j`，`logback` 等日志框架，默认使用 `logback`，它是 `log4j` 的改进版，不能单独使用，推荐配合 `slf4j` 一起使用：
- 日志级别：DEBUG < INFO < WARN < ERROR。
- 核心对象：
    - `Logger`：日志记录器，负责记录日志。
    - `Appender`：日志追加器，指定日志输出位置。
    - `Layout`：日志布局器，指定日志信息的格式。
- 引入依赖：`spring-boot-starter` 中包含了 `spring-boot-starter-logging` 依赖。
- 日志配置：springboot会默认加载classpath下的 `logback.xml` 或 `logback-spring.xml`：
    - 自定义日志配置需要在主配文件中配置：`logging.config=classpath:my-log.xml`。
- 控制台记录日志：
    - `<appender>` 表示一个日志追加器。
        - `name`：Appender的名字。
        - `class=ch.qos.logback.core.ConsoleAppender`：将日志输出在控制台。
    - `<encoder>`：用来表示一个编码器，它有两个子标签：
    - `<pattern>`：用来指定编码格式。
    - `<charset>`：用来指定编码字符集。
    - `<root>`：用来配置根记录器，包含0或多个 `<appender-ref>`，建议放在最后位置。
        - `level`：指定最低日志级别，可选字符串值：TRACE，DEBUG，INFO，WARN，ERROR，ALL，OFF，不区分大小写。
    - `<appender-ref>`：指向某个 <appender> 的 name 属性，负责将其添加到根记录器中。
- 开发动作类：
    - `Logger logger = LoggerFactory.getLogger(LogBackController.class)`：获取当前类的日志记录器。
    - `logger.debug("")`：记录一条DEBUG级别的日志信息。
    - `logger.info("")`：记录一条INFO级别的日志信息。
    - `logger.warn("")`：记录一条WARN级别的日志信息。
    - `logger.error("")`：记录一条ERROR级别的日志信息。

**源码：** /springboot2/
- res: `classpath:my-log.xml`
- src: `c.j.s.controller.LogBackController`
- psm: `api/logback/test`


2.3 日志格式解析

概念：

<pattern> 中的规则越复杂，效率越低，尤其像类/方法/行号之类的占位符，应尽量避免使用。
<pattern> 中的日志输出格式支持使用空格、- 或 : 进行分割，其余占位符见下表。
占位符	含义
%d{yyyy-MM-dd HH:mm:ss.SSS}	日期，括号中为格式
%highlight()	对括号中的日志级别进行高亮修饰
DEBUG 级别显示为黑色
INFO 级别显示为蓝色
WARN 级别显示为浅红
ERROR 级别显示为深红
%-5p / %-5level	日志级别，不够5个字符在末尾补足至5个字符
%4.15()	对括号中的字符串进行长度判断
小于4，则左补空格至长度为4
大于15，从开头开始截取保留15个
%t	打印日志的线程，t 同 thead
%cyan()	对括号中的日志级别进行蓝色修饰
%-40.50()	对括号中的字符串进行长度判断
小于40，则右补空格至长度为4
大于50，从开头开始截取保留50个
%c{50} / %logger{50}	日志对应的类全名，括号中判断字符串 
长度少于50：正常显示
长度大于50：从第一个点前的包名开始折叠为首字母，如 com 变为 c，直到长度小于50
%M / %method	日志对应的方法名
%L / %line	日志对应代码行号
%msg	日志输出内容
%n	换行


3. 日志输出到文件中

概念：

<appender> 的 class=ch.qos.logback.core.rolling.RollingFileAppender 时表示该Appender可以将日志输出指定的log文件中。
<file>：指定了日志文件路径，默认位置相对于项目，支持使用绝对路径。
<append>：设置是否追加日志，默认为true。
<filter>：日志等级过滤器，常用的有两种：
ch.qos.logback.classic.filter.ThresholdFilter：范围等级过滤器，有一个子标签：
<level>：来指定日志等级，必须等于或大于该等级，才会记录日志。
ch.qos.logback.classic.filter.LevelFilter：精准等级过滤器，有三个子标签：
<level>：指定日志等级。
<onMatch>：命中了指定的日志等级后的操作：
DENY：表示阻止记录该条日志。
ACCEPT：表示允许记录该条日志。
<onMissMatch>：未命中指定的日志等级后的操作：
DENY：表示阻止记录该条日志。
ACCEPT：表示允许记录该条日志。
<rollingPolicy>：设置滚动策略，一般推荐使用 ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy 策略，策略内容为：
先按照日期，将日志记录到 <file> 指定的log文件中，如 my.log。
如果日期变化了，将前一天的日志文件 my.log 重命名为 my.2020-01-01.0.log，格式固定为文件名 + 日期 + 拆分索引。
原日志文件重命名后，新日志文件名字仍使用 my.log。
如果日期没有变化，但日志大小超过某个设定值，如100M，则对日志进行分割，如将 my.log 拆为 my + 日期 + 1.log 和 my + 日期 + 2.log。
<rollingPolicy> 有四个子标签：
<fileNamePattern>：log/warn.%d.%i.log</fileNamePattern>
<maxHistory>：设置每产生一个日志文件，该日志文件最多保存多久，该值的单位是根据 <fileNamePattern> 的值自动推算的：
如 <fileNamePattern> 中选用了 yyyy-MM-dd，则单位为天。
如 <fileNamePattern> 中选用了 yyyy-MM，则单位为月。
<totalSizeCap>：日志最大限制，数值需要加单位，超出此值立刻删除多余日志。
<maxFileSize>：日志切分阈值，默认值是10MB，数值需要加单位，文件超过这个阈值时开始切分。
<logger>：负责追踪运行时日志（不包括启动日志），使用子标签 <appender-ref> 来指定具体的Appender。
name：指定包名。
level：指定最低日志级别。

3.1 配置

需求： 只将WRAN信息输出在 /log/warn.log 文件中。

配置： logback-spring.xml

<?xml version="1.0" encoding="UTF-8"?>
<configuration>

    <!--控制台输出Appender-->
    <appender name="STDOUT" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %highlight(%-5p) - [%4.15(%t)] %cyan(%c{50}.%M:%L) : %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>
    </appender>

    <!--文件日志Appender-->
    <appender name="WARN" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>log/warn.log</file>
        <append>true</append>

        <!--过滤器：不记录ERROR，只记录WARN-->
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>DENY</onMatch>
            <onMismatch>ACCEPT</onMismatch>
        </filter>

        <!--滚动策略-->
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>log/warn.%d.%i.log</fileNamePattern>
            <maxHistory>30</maxHistory>
            <totalSizeCap>10GB</totalSizeCap>
            <maxFileSize>10MB</maxFileSize>
        </rollingPolicy>

        <!--编码器-->
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} %-5p - [%4.10(%t)] %c{50}.%M:%L : %msg%n</pattern>
            <charset>UTF-8</charset>
        </encoder>

    </appender>

    <!--日志记录器-->
    <logger name="com.joe.app.controller" level="WARN">
        <appender-ref ref="WARN"/>
    </logger>

    <root level="INFO">
        <appender-ref ref="STDOUT"/>
    </root>

</configuration>
文件日志不支持 %highlight() 或 %cyan() 之类的颜色属性词。