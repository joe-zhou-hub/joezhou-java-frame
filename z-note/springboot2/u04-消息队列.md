# 1. ActiveMQ

**流程：** [activemq官网](http://activemq.apache.org/) 是apache公司的一个消息队列产品：
- 启动 `%ACTIVEMQ_HOME%\bin\win64\activemq.bat`
- 访问 `127.0.0.1:8161` 进入AMQ管理界面，账密都是 `admin`。
- 点击 `Manage ActiveMQ broker` 管理AMQ的经纪人（管控台）。
- 创建队列：点击 `queues` 选项卡，输入以 `queue` 后缀的队列名，点击 `create`：
    - `Name`：队列名称
    - `Number Of Pending Messages`：待消费消息数。
    - `Number Of Consumers`：消费者数。
    - `Messages Enqueued`：总消息数，包括待消费和已消费的，只增不减。
    - `Messages Dequeued`：已消费消息数。
- 向队列发送消息：点击 `send` 选项卡，输入目标队列名和消息内容，点击 `send`：
    - `destination`：目标队列名。
    - `message body`：消息内容。

## 1.1 springboot整合

**流程：** 新建springboot-jar项目 `springboot2-activemq`
- 配置pom依赖：`spring-boot-starter-activemq/pooled-jms`
- 主配开启AMQ：均以 `spring.activemq` 前缀：
    - `broker-url=tcp://localhost:61616`：连接AMQ经纪人，默认端口61616。
    - `broker-url=failover:(tcp://localhost:61616,tcp://localhost:61617)`：连接AMQ经纪人集群。
    - `user=admin`：TCP账号为admin。
    - `password=admin`：TCP连接密码为admin。
    - `pool.enabled=true`：开启AMQ池。
    - `pool.max-connections=50`：AMQ最大容量为50个连接。
- 启动类上添加 `@EnableJms` 支持JMS。

**流程：** 生产消费模型：生产者生产消息，所有消费者轮流消费该消息：
- 开发生产者类 `c.j.s.producer.ProducerA`：注入 `o.s.j.c.JmsMessagingTemplate` 类：
    - `new ActiveMQQueue(queueName)`：根据队列名创建目标队列 `Destination` 对象。
    - `jmsMessagingTemplate.convertAndSend(destination, msg)`：向目标队列发送消息。
- 开发动作类 `c.j.s.controller.ProducerController`：注入生产者类并调用其发送消息方法。
- 开发消费者类 `c.j.s.consumer.ConsumerA`：
    - 消费方法标记 `@JmsListener`：当 `destination` 指定的队列有新消息时执行。
    - 消费方法对形参 `ActiveMQTextMessage` 调用 `getText()` 可接收字符串消息。
- psm测试：`producer/send-to-queue`

**流程：** 发布订阅模型：发布者发布消息，所有订阅者同时消费该消息：
- 主配添加 `spring.jms.pub-sub-domain=true` 以支持发布订阅模型。
- 开发发布者类 `c.j.s.publish.PublishA`：注入 `o.s.j.c.JmsMessagingTemplate` 类：
    - `new ActiveMQTopic(queueName)`：根据队列名创建目标队列 `Destination` 对象。
    - `jmsMessagingTemplate.convertAndSend(destination, msg)`：向目标队列发送消息。
- 开发动作类 `c.j.s.controller.PublishController`：注入发布者类并调用其发送消息方法。
- 开发消费者类 `c.j.s.consumer.ConsumerA`：
    - 消费方法标记 `@JmsListener`：当 `destination` 指定的队列有新消息时执行。
    - 消费方法对形参 `ActiveMQTextMessage` 调用 `getText()` 可接收字符串消息。
- psm测试：`producer/send-to-topic`

# 5. 同时支持点对点和发布订阅

**概念：** activemq的点对点模型和发布订阅模型默认不能共存。

1. 注释掉 `spring.jms.pub-sub-domain=true` 配置。
2. 在订阅者类的每个监听方法注解 `@JmsListener` 中添加 `containerFactory = "jmsListenerContainerTopic"` 属性。
3. 在启动类重写Jms监听工厂，如下：

**源码：** 启动类中添加
```java
@Bean
public JmsListenerContainerFactory<?> jmsListenerContainerTopic(ConnectionFactory activeMQConnectionFactory) {
    DefaultJmsListenerContainerFactory bean = new DefaultJmsListenerContainerFactory();
    bean.setPubSubDomain(true);
    bean.setConnectionFactory(activeMQConnectionFactory);
    return bean;
}
```

