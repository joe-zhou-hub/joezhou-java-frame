# 1. 概念入门

**概念：** spring-security是spring用于提供声明式安全访问控制解决方案的安全框架：
- 认证：核心是比对用户的账号密码身份等信息，而验证指的是某些规则的匹配。
- 授权：为用户赋权或赋角色。

**流程：** 创建springboot-jar项目 `springboot2-security`：
- 配置项目依赖：idea直接选择 `security/spring security` 依赖：
    - `spring-boot-starter-security`：security核心包。
    - `spring-boot-starter-web`：spring-web核心包。
    - `spring-boot-starter-thymeleaf`：thymeleaf核心包，选用。
    - `thymeleaf-extras-springsecurity5`：thymeleaf和security整合包，选用。
    - `spring-security-test`：security测试包。
- 主配添加thymeleaf相关配置：关闭缓存，前后缀，编码，静态资源路径等。
- 开发测试页面 `classpath:templates/start.html`。
- cli: `start.html`：发现整个项目资源都被security保护起来：
    - 所有请求重定向到security默认的登录路由 `/login` 并展示security内置的登录页面。
    - 输入账号 `user` 和在日志中生成的随机密码，点击登录。
    - 登陆成功后，security默认访问登陆前一次的URL，404时默认寻找 `error.html`。
    - 测试时注意浏览器缓存问题，浏览器完全关闭时视为注销登陆。
- 自定义账密：在主配中设置自定义账密后，日志将不再生成随机登录密码：
    - `spring.security.user.name=joezhou`：自定义security账号。
    - `spring.security.user.password=123`：自定义security密码。
    - `spring.security.user.roles=TEST`：自定义账号角色，逗号分隔，不要使用 `ROLE_` 前缀。
- cli: `start.html`：输入自定义账号密码。

# 2. 资源放行

**概念：** 对于首页，广告页等请求不需要security保护，需要放行：
- 开发配置类 `c.j.s.config.SecurityConfig`：
    - 标记 `@Configuration` 声明为配置类。
    - 标记 `@EnableWebSecurity` 以启用security功能。
- 配置类重写 `o.s.s.c.a.w.c.WebSecurityConfigurerAdapter.configure()`：
    - `http.authorizeRequests()`：权限请求设置。
    - `antMatchers(URL).permitAll()`：表示放行某些指定规则的请求URL。
    - `anyRequest().authenticated()`：表示其余的任何请求都需要认证。
    - `and()`：用于连接并列关系的配置。
    - `formLogin()`：用于恢复security表单登陆功能。
- cli: `/index.html`，`/` 和 `/ad.html` 直接放行，而其他URL仍被security保护。

# 3. 自定义登陆页面

**流程：** 
- 在 `configure()` 中的 `formLogin()` 后额外配置，所有URL都建议使用动作方法的路由：
    - `loginPage(URL)`：自定义登录URL。
    - `loginProcessingUrl(URL)`：设置自定义登录表单的 `action` 值。
    - `successForwardUrl()`：登陆成功后的跳转URL，缺省返回上一次的请求路径，，且附带 `?success`。
    - `failureForwardUrl()`：登录失败后的跳转URL，缺省跳到 `loginPage()` 指定的URL，且附带 `?error`，该内容可在页面使用thymeleaf标签获取。
    - `permitAll()`：表示放行以上全部路径或路由。
    - `csrf().disable()`：禁止跨域防护，即允许跨域请求，不配置此项则自定义表单会登陆不成功。
- 开发动作类 `c.j.s.controller.UserController`：添加三个动作方法：
- 开发动作方法 `loginPageRouting()` 负责将 `loginPage()` 中的请求路由到 `/templates/login.html`。
- 开发动作方法 `loginSuccess()` 负责将 `successForwardUrl()` 中的请求路由到 `/templates/main.html`：
    - `SecurityContextHolder.getContext().getAuthentication()`：获取 `Authentication` 对象，包含着本次登陆认证的相关信息，这个对象在登陆成功后可以随时随地获取。
    - `authentication.getAuthorities()`：获取所有的角色和权限。
    - `authentication.getName()`：获取用户名。
- 开发登录页面 `templates\login.html`：
    - 引入thymeleaf标签：`xmlns:th="https://www.thymeleaf.org"`。
    - 设计表单，注意 `action` 一定要与 `loginProcessingUrl()` 中的值保持一致。 
    - 表单的账号和密码控件建议命名为 `username` 和 `password`。
- 开发登录成功页面 `main.html`：
    - 引入security标签：`xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"`。
    - `sec:authorize="isAuthenticated()"`：表示只有在认证成功时才会展示标签及标签中的内容。
    - `sec:authentication="name"`：可以获取 `Authentication` 对象中的 `name` 信息，其余同理。



    - security因账号密码输出错误而导致登陆失败时，会自动路由到 `login.html` 页面，且在路径后附加 `?error` 提示，前提是你没有配置 `failureForwardUrl()`，而页面中的 `th:if="${param.error}` 可以捕获到路径中的 `?error` 后缀，并将标签和内容展示给用户。
    - security在注销时，会自动路由到 `login.html` 页面，且在路径后附加 `?logout` 提示，thymeleaf标签 可使用 "${param.logout}` 可以捕获到路径中的 `?logout` 后缀，并将标签和内容展示给用户。






```!
`loginProcessingUrl()` 中的地址不需要路由，
因为负责登陆的 `login` 使用的是security中的方法，这个方法无需我们自己编写，
而且即使你写了一个 `login.action` 动作方法也不会被执行，
所以你只需要保持 `loginProcessingUrl()` 中的地址和你自定义登陆表单的 `action` 的值一致即可。
```