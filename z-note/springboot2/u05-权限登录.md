# 1. 概念入门

**概念：** spring-security是spring用于提供声明式安全访问控制解决方案的安全框架：
- 认证：核心是比对用户的账号密码身份等信息，而验证指的是某些规则的匹配。
- 授权：为用户赋权或赋角色。

**流程：** 创建springboot-jar项目 `springboot2-security`：
- 配置项目依赖：idea直接选择 `security/spring security` 依赖：
    - `spring-boot-starter-security`：security核心包。
    - `spring-boot-starter-web`：spring-web核心包。
    - `spring-boot-starter-thymeleaf`：thymeleaf核心包，选用。
    - `thymeleaf-extras-springsecurity5`：thymeleaf和security整合包，选用。
    - `spring-security-test`：security测试包。
- 主配添加thymeleaf相关配置：关闭缓存，前后缀，编码，静态资源路径等。
- 开发测试页面 `templates/start.html`。
- cli: `start.html`：发现整个项目资源都被security保护起来：
    - 所有请求重定向到security默认的登录路由 `/login` 并展示security内置的登录页面。
    - 输入账号 `user` 和在日志中生成的随机密码，点击登录。
    - 登陆成功后，security默认访问登陆前一次的URL，404时默认寻找 `error.html`。
    - 测试时注意浏览器缓存问题，浏览器完全关闭时视为注销登陆。
- 自定义账密：在主配中设置自定义账密后，日志将不再生成随机登录密码：
    - `spring.security.user.name=joezhou`：自定义security账号。
    - `spring.security.user.password=123`：自定义security密码。
    - `spring.security.user.roles=TEST`：自定义账号角色，逗号分隔，不要使用 `ROLE_` 前缀。
- cli: `start.html`：输入自定义账号密码。

# 2. 资源放行

**概念：** 对于首页，广告页等请求不需要security保护，需要放行：
- 开发配置类 `c.j.s.config.SecurityConfig`：
    - 标记 `@Configuration` 声明为配置类。
    - 标记 `@EnableWebSecurity` 以启用security功能。
- 配置类重写 `o.s.s.c.a.w.c.WebSecurityConfigurerAdapter.configure()`：
    - `http.authorizeRequests()`：权限请求设置。
    - `antMatchers(URL).permitAll()`：表示放行某些指定规则的请求URL。
    - `anyRequest().authenticated()`：表示其余的任何请求都需要认证。
    - `and()`：用于连接并列关系的配置。
    - `formLogin()`：用于恢复security表单登陆功能。
- cli: `/index.html`，`/` 和 `/ad.html` 直接放行，而其他URL仍被security保护。

# 3. 自定义登陆页面

**流程：** 
- 开发动作类 `c.j.s.controller.UserController`：
    - `loginRouting()`：用于提供登录页面 `/templates/login.html` 的路由。
    - `loginSuccess()`：用于提供登录成功页面 `/templates/main.html` 的路由。
    - `SecurityContextHolder.getContext().getAuthentication()`：登陆成功后可随时获取security认证信息。
- 在 `configure()` 中的 `formLogin()` 后额外配置，所有URL都建议使用动作方法的路由：
    - `loginPage(URL)`：设置自定义登录页面路由。
    - `loginProcessingUrl(URL)`：设置登录处理路径，命名随意。
    - `successForwardUrl(URL)`：设置登录成功页面的路由，缺省跳转至上次的请求路径。
    - `failureForwardUrl(URL)`：设置登录失败页面的路由，缺省跳转至 `loginPage()` 指定的路由。
    - `permitAll()`：表示放行以上全部路径或路由。
    - `csrf().disable()`：禁止跨域防护，即允许跨域请求，缺省时自定义表单登录功能失效。
- 开发登录页面 `templates\login.html`：
    - 引入thymeleaf标签：`xmlns:th="https://www.thymeleaf.org"`。
    - 设计表单，`action` 的值必须和 `loginProcessingUrl()` 配置的路径一致。
    - 账号和密码控件建议命名为 `username` 和 `password`。
    - `${param.error}`：获取账密错误时，security跳转至 `loginPage()` 指定的路由时附加的 `?error`。
    - `${param.logout}`：获取注销登录时，security跳转至 `loginPage()` 指定的路由时附加的 `?logout`。
- 开发登录成功页面 `templates\main.html`：
    - 引入security标签：`xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"`。
    - `sec:authorize="isAuthenticated()"`：仅在认证成功时才会展示标签及标签中的内容。
    - `sec:authentication="name"`：获取认证信息中的账号信息，其余同理。
    - `sec:authentication="principal"`：获取认证信息中的主要信息，如密码（受保护），过期时间等。